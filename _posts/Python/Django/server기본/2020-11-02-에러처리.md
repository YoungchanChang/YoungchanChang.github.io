---
layout: post
title: 장고 에러처리
category: Django
tags: [python, Django]
comments: Django
---

# 에러처리의 중요성

- 서버가 한 번 다운되면 돈이 날라간다. 그런데 서버에서 모든 상황에 대해서 처리를 할 수 없다. 따라서 예상되지 않은 코드에 대해서 예외처리를 진행하고, 예외처리사항을 로그로 남긴 뒤에 나중에 수정하는 방법을 쓸 수 있다.

# 로직 흐름

- 1.사용자가 서버에 Request를 날린다.

- 2.서버에서 Request값을 처리하는 모듈에 전달한다.

- 3.모듈에서 Request값에 대한 처리를 `Try: 실행코드 Except 예외코드`안에 넣는다.

- 4.모듈에서 try이건 except이건 return으로 돌려준다.

- 5.서버에서 해당 return값을 받은 뒤에 쓰레드로 로그를 남긴다.

- 6.리턴값을 사용자에게 돌려준다.

<center>
<figure>
<img src="https://imgur.com/USe55Gn.png" alt="views">
<figcaption></figcaption>
</figure>
</center>

# 로직 상세 코드

- 서버에서 처리하는 모듈

- 서버에서는 모듈에 request값을 건네준다. 그리고 쓰레드로 기록하면 된다.

```python
@app.route('/')
def home():
    svc_name = "/home"
    input_json = "-"
    return_json = {
        "content": "",
        "content_status": "return"
    }
    
    try:
        query_content = request.args.get('query_content')

        input_json = {
            "query_content" : query_content,
        }

        # 모듈에 값을 건네준다.
        elastic_result_json = get_json(query_content=query_content)

        if elastic_result_json["status"] == 500:
            raise Exception

        # 로그에 기록을 남긴다.
        log_thread = threading.Thread(
            target=log.save_server_logs, args=(svc_name, str(input_json), str(return_json)))
        log_thread.start()

        return make_response(jsonify(return_json), 200)

    except Exception:

        log_thread = threading.Thread(
            target=log.save_server_errors, args=(svc_name, str(input_json), str(return_json)))
        log_thread.start()

        return make_response(jsonify(return_json), 500)

app.run(host=os.getenv('server_ip_addr'), port=os.getenv('server_port'))
```

- 모듈에서 처리

- 의미를 명확하게 하기 위해 Error를 상속받아서 처리한다.

```python
class _KeyError(ValueError):
    pass

class _ValueError(ValueError):
    pass

def get_json(query_content, user_type):
    json_return_format = {
        "content": "",
        "content_status": "emotok",
        "status": 500
    }

    try:
        # 값에 대해서 검증한다.
        if type(query_content) is not str:
            raise _KeyError

        if user_type not in user_must_type:
            raise _ValueError

        json_return_format["status"] = 200

    except _KeyError:
        json_return_format['content'] = "[Error] _KeyError"

    except _ValueError:
        json_return_format['content'] = "[Error] _ValueError"

    except Exception:
        json_return_format['content'] = traceback.format_exc()

    finally:
        return json_return_format

```